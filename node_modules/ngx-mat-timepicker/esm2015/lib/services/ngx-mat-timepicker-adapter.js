/**
 * @fileoverview added by tsickle
 * Generated from: lib/services/ngx-mat-timepicker-adapter.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { NgxMatTimepickerFormat } from "../models/ngx-mat-timepicker-format.enum";
import { NgxMatTimepickerPeriods } from "../models/ngx-mat-timepicker-periods.enum";
//
import { DateTime } from "ts-luxon";
// @dynamic
export class NgxMatTimepickerAdapter {
    /**
     *
     *  Format hour according to time format (12 or 24)
     * @param {?} currentHour
     * @param {?} format
     * @param {?} period
     * @return {?}
     */
    static formatHour(currentHour, format, period) {
        if (format === 24) {
            return currentHour;
        }
        /** @type {?} */
        const hour = period === NgxMatTimepickerPeriods.AM ? currentHour : currentHour + 12;
        if (period === NgxMatTimepickerPeriods.AM && hour === 12) {
            return 0;
        }
        else if (period === NgxMatTimepickerPeriods.PM && hour === 24) {
            return 12;
        }
        return hour;
    }
    /**
     * @param {?} time
     * @param {?} opts
     * @return {?}
     */
    static formatTime(time, opts) {
        if (!time) {
            return "Invalid Time";
        }
        const { format } = opts;
        /** @type {?} */
        const parsedTime = NgxMatTimepickerAdapter.parseTime(time, opts).setLocale(NgxMatTimepickerAdapter.defaultLocale);
        if (format !== 24) {
            return parsedTime.toLocaleString(Object.assign(Object.assign({}, DateTime.TIME_SIMPLE), { hour12: format !== 24 })).replace(/\u200E/g, "");
        }
        return parsedTime.toISOTime({
            includeOffset: false,
            suppressMilliseconds: true,
            suppressSeconds: true
        }).replace(/\u200E/g, "");
    }
    /**
     * @param {?} time
     * @param {?} format
     * @return {?}
     */
    static fromDateTimeToString(time, format) {
        /** @type {?} */
        const timeFormat = format === 24 ? NgxMatTimepickerFormat.TWENTY_FOUR : NgxMatTimepickerFormat.TWELVE;
        return time.reconfigure({
            numberingSystem: NgxMatTimepickerAdapter.defaultNumberingSistem,
            locale: NgxMatTimepickerAdapter.defaultLocale
        }).toFormat(timeFormat);
    }
    /**
     * @param {?} time
     * @param {?} before
     * @param {?} after
     * @param {?=} unit
     * @return {?}
     */
    static isBetween(time, before, after, unit = "minutes") {
        if (unit === "hours") {
            return this.isSameOrBefore(time, after, unit) && this.isSameOrAfter(time, before, unit);
        }
        if (unit === "minutes") {
            return this.isSameOrBefore(time, after) && this.isSameOrAfter(time, before);
        }
    }
    /**
     * @param {?} time
     * @param {?} compareWith
     * @param {?=} unit
     * @return {?}
     */
    static isSameOrAfter(time, compareWith, unit = "minutes") {
        if (unit === "hours") {
            return time.hour >= compareWith.hour;
        }
        if (unit === "minutes") {
            return time.hasSame(compareWith, unit) || time.valueOf() > compareWith.valueOf();
        }
    }
    /**
     * @param {?} time
     * @param {?} compareWith
     * @param {?=} unit
     * @return {?}
     */
    static isSameOrBefore(time, compareWith, unit = "minutes") {
        if (unit === "hours") {
            return time.hour <= compareWith.hour;
        }
        if (unit === "minutes") {
            return time.hasSame(compareWith, unit) || time.valueOf() <= compareWith.valueOf();
        }
    }
    /**
     * @param {?} time
     * @param {?=} min
     * @param {?=} max
     * @param {?=} granularity
     * @param {?=} minutesGap
     * @param {?=} format
     * @return {?}
     */
    static isTimeAvailable(time, min, max, granularity, minutesGap, format) {
        if (!time) {
            return;
        }
        /** @type {?} */
        const convertedTime = this.parseTime(time, { format });
        /** @type {?} */
        const minutes = convertedTime.minute;
        if (minutesGap && minutes === minutes && minutes % minutesGap !== 0) {
            throw new Error(`Your minutes - ${minutes} doesn\'t match your minutesGap - ${minutesGap}`);
        }
        /** @type {?} */
        const isAfter = (min && !max)
            && this.isSameOrAfter(convertedTime, min, granularity);
        /** @type {?} */
        const isBefore = (max && !min)
            && this.isSameOrBefore(convertedTime, max, granularity);
        /** @type {?} */
        const between = (min && max)
            && this.isBetween(convertedTime, min, max, granularity);
        /** @type {?} */
        const isAvailable = !min && !max;
        return isAfter || isBefore || between || isAvailable;
    }
    /**
     * @param {?} time
     * @param {?} opts
     * @return {?}
     */
    static parseTime(time, opts) {
        const { numberingSystem, locale } = NgxMatTimepickerAdapter._getLocaleOptionsByTime(time, opts);
        /** @type {?} */
        const isPeriodExist = time.split(" ").length === 2;
        /** @type {?} */
        const timeMask = isPeriodExist ? NgxMatTimepickerFormat.TWELVE_SHORT : NgxMatTimepickerFormat.TWENTY_FOUR_SHORT;
        return DateTime.fromFormat(time, timeMask, { numberingSystem, locale });
    }
    /**
     * @param {?} time
     * @param {?=} opts
     * @return {?}
     */
    static toLocaleTimeString(time, opts = {}) {
        const { format = NgxMatTimepickerAdapter.defaultFormat, locale = NgxMatTimepickerAdapter.defaultLocale } = opts;
        /** @type {?} */
        const hourCycle = format === 24 ? "h23" : "h12";
        /** @type {?} */
        const timeFormat = Object.assign(Object.assign({}, DateTime.TIME_SIMPLE), { hourCycle });
        /** @type {?} */
        const timeMask = (format === 24) ? NgxMatTimepickerFormat.TWENTY_FOUR_SHORT : NgxMatTimepickerFormat.TWELVE_SHORT;
        return DateTime.fromFormat(time, timeMask).setLocale(locale).toLocaleString(timeFormat);
    }
    /**
     * @private
     * @param {?} time
     * @param {?} opts
     * @return {?}
     */
    static _getLocaleOptionsByTime(time, opts) {
        const { numberingSystem, locale } = DateTime.local().setLocale(opts.locale).resolvedLocaleOpts();
        /** @type {?} */
        const localeConfig = {
            numberingSystem: (/** @type {?} */ (numberingSystem)),
            locale
        };
        /** @type {?} */
        const defaultConfig = {
            numberingSystem: NgxMatTimepickerAdapter.defaultNumberingSistem,
            locale: NgxMatTimepickerAdapter.defaultLocale
        };
        return isNaN(parseInt(time, 10)) ? localeConfig : defaultConfig;
    }
}
NgxMatTimepickerAdapter.defaultFormat = 12;
NgxMatTimepickerAdapter.defaultLocale = "en-US";
NgxMatTimepickerAdapter.defaultNumberingSistem = "latn";
if (false) {
    /** @type {?} */
    NgxMatTimepickerAdapter.defaultFormat;
    /** @type {?} */
    NgxMatTimepickerAdapter.defaultLocale;
    /** @type {?} */
    NgxMatTimepickerAdapter.defaultNumberingSistem;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LW1hdC10aW1lcGlja2VyLWFkYXB0ZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtbWF0LXRpbWVwaWNrZXIvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvbmd4LW1hdC10aW1lcGlja2VyLWFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUMsc0JBQXNCLEVBQUMsTUFBTSwwQ0FBMEMsQ0FBQztBQUNoRixPQUFPLEVBQUMsdUJBQXVCLEVBQUMsTUFBTSwyQ0FBMkMsQ0FBQzs7QUFHbEYsT0FBTyxFQUFDLFFBQVEsRUFBaUMsTUFBTSxVQUFVLENBQUM7O0FBR2xFLE1BQU0sT0FBTyx1QkFBdUI7Ozs7Ozs7OztJQVNoQyxNQUFNLENBQUMsVUFBVSxDQUFDLFdBQW1CLEVBQUUsTUFBYyxFQUFFLE1BQStCO1FBQ2xGLElBQUksTUFBTSxLQUFLLEVBQUUsRUFBRTtZQUNmLE9BQU8sV0FBVyxDQUFDO1NBQ3RCOztjQUNLLElBQUksR0FBRyxNQUFNLEtBQUssdUJBQXVCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLFdBQVcsR0FBRyxFQUFFO1FBRW5GLElBQUksTUFBTSxLQUFLLHVCQUF1QixDQUFDLEVBQUUsSUFBSSxJQUFJLEtBQUssRUFBRSxFQUFFO1lBQ3RELE9BQU8sQ0FBQyxDQUFDO1NBQ1o7YUFDSSxJQUFJLE1BQU0sS0FBSyx1QkFBdUIsQ0FBQyxFQUFFLElBQUksSUFBSSxLQUFLLEVBQUUsRUFBRTtZQUMzRCxPQUFPLEVBQUUsQ0FBQztTQUNiO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQzs7Ozs7O0lBRUQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFZLEVBQUUsSUFBNkI7UUFDekQsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNQLE9BQU8sY0FBYyxDQUFDO1NBQ3pCO2NBQ0ssRUFBQyxNQUFNLEVBQUMsR0FBRyxJQUFJOztjQUNmLFVBQVUsR0FBRyx1QkFB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WUFDL0QsTUFBTSxFQUFFLHVCQUF1QixDQUFDLGFBQWE7U0FDaEQ7UUFFRCxPQUFPLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDO0lBQ3BFLENBQUM7O0FBeElNLHFDQUFhLEdBQUcsRUFBRSxDQUFDO0FBQ25CLHFDQUFhLEdBQUcsT0FBTyxDQUFDO0FBQ3hCLDhDQUFzQixHQUFvQixNQUFNLENBQUM7OztJQUZ4RCxzQ0FBMEI7O0lBQzFCLHNDQUErQjs7SUFDL0IsK0NBQXdEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtOZ3hNYXRUaW1lcGlja2VyRm9ybWF0fSBmcm9tIFwiLi4vbW9kZWxzL25neC1tYXQtdGltZXBpY2tlci1mb3JtYXQuZW51bVwiO1xuaW1wb3J0IHtOZ3hNYXRUaW1lcGlja2VyUGVyaW9kc30gZnJvbSBcIi4uL21vZGVscy9uZ3gtbWF0LXRpbWVwaWNrZXItcGVyaW9kcy5lbnVtXCI7XG5pbXBvcnQge05neE1hdFRpbWVwaWNrZXJPcHRpb25zfSBmcm9tIFwiLi4vbW9kZWxzL25neC1tYXQtdGltZXBpY2tlci1vcHRpb25zLmludGVyZmFjZVwiO1xuLy9cbmltcG9ydCB7RGF0ZVRpbWUsIExvY2FsZU9wdGlvbnMsIE51bWJlcmluZ1N5c3RlbX0gZnJvbSBcInRzLWx1eG9uXCI7XG5cbi8vIEBkeW5hbWljXG5leHBvcnQgY2xhc3MgTmd4TWF0VGltZXBpY2tlckFkYXB0ZXIge1xuXG4gICAgc3RhdGljIGRlZmF1bHRGb3JtYXQgPSAxMjtcbiAgICBzdGF0aWMgZGVmYXVsdExvY2FsZSA9IFwiZW4tVVNcIjtcbiAgICBzdGF0aWMgZGVmYXVsdE51bWJlcmluZ1Npc3RlbTogTnVtYmVyaW5nU3lzdGVtID0gXCJsYXRuXCI7XG5cbiAgICAvKioqXG4gICAgICogIEZvcm1hdCBob3VyIGFjY29yZGluZyB0byB0aW1lIGZvcm1hdCAoMTIgb3IgMjQpXG4gICAgICovXG4gICAgc3RhdGljIGZvcm1hdEhvdXIoY3VycmVudEhvdXI6IG51bWJlciwgZm9ybWF0OiBudW1iZXIsIHBlcmlvZDogTmd4TWF0VGltZXBpY2tlclBlcmlvZHMpOiBudW1iZXIge1xuICAgICAgICBpZiAoZm9ybWF0ID09PSAyNCkge1xuICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRIb3VyO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGhvdXIgPSBwZXJpb2QgPT09IE5neE1hdFRpbWVwaWNrZXJQZXJpb2RzLkFNID8gY3VycmVudEhvdXIgOiBjdXJyZW50SG91ciArIDEyO1xuXG4gICAgICAgIGlmIChwZXJpb2QgPT09IE5neE1hdFRpbWVwaWNrZXJQZXJpb2RzLkFNICYmIGhvdXIgPT09IDEyKSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChwZXJpb2QgPT09IE5neE1hdFRpbWVwaWNrZXJQZXJpb2RzLlBNICYmIGhvdXIgPT09IDI0KSB7XG4gICAgICAgICAgICByZXR1cm4gMTI7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaG91cjtcbiAgICB9XG5cbiAgICBzdGF0aWMgZm9ybWF0VGltZSh0aW1lOiBzdHJpbmcsIG9wdHM6IE5neE1hdFRpbWVwaWNrZXJPcHRpb25zKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKCF0aW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gXCJJbnZhbGlkIFRpbWVcIjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB7Zm9ybWF0fSA9IG9wdHM7XG4gICAgICAgIGNvbnN0IHBhcnNlZFRpbWUgPSBOZ3hNYXRUaW1lcGlja2VyQWRhcHRlci5wYXJzZVRpbWUodGltZSwgb3B0cykuc2V0TG9jYWxlKE5neE1hdFRpbWVwaWNrZXJBZGFwdGVyLmRlZmF1bHRMb2NhbGUpO1xuXG4gICAgICAgIGlmIChmb3JtYXQgIT09IDI0KSB7XG4gICAgICAgICAgICByZXR1cm4gcGFyc2VkVGltZS50b0xvY2FsZVN0cmluZyh7XG4gICAgICAgICAgICAgICAgLi4uRGF0ZVRpbWUuVElNRV9TSU1QTEUsXG4gICAgICAgICAgICAgICAgaG91cjEyOiBmb3JtYXQgIT09IDI0XG4gICAgICAgICAgICB9KS5yZXBsYWNlKC9cXHUyMDBFL2csIFwiXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHBhcnNlZFRpbWUudG9JU09UaW1lKHtcbiAgICAgICAgICAgIGluY2x1ZGVPZmZzZXQ6IGZhbHNlLFxuICAgICAgICAgICAgc3VwcHJlc3NNaWxsaXNlY29uZHM6IHRydWUsXG4gICAgICAgICAgICBzdXBwcmVzc1NlY29uZHM6IHRydWVcbiAgICAgICAgfSkucmVwbGFjZSgvXFx1MjAwRS9nLCBcIlwiKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZnJvbURhdGVUaW1lVG9TdHJpbmcodGltZTogRGF0ZVRpbWUsIGZvcm1hdDogbnVtYmVyKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgdGltZUZvcm1hdCA9IGZvcm1hdCA9PT0gMjQgPyBOZ3hNYXRUaW1lcGlja2VyRm9ybWF0LlRXRU5UWV9GT1VSIDogTmd4TWF0VGltZXBpY2tlckZvcm1hdC5UV0VMVkU7XG5cbiAgICAgICAgcmV0dXJuIHRpbWUucmVjb25maWd1cmUoe1xuICAgICAgICAgICAgbnVtYmVyaW5nU3lzdGVtOiBOZ3hNYXRUaW1lcGlja2VyQWRhcHRlci5kZWZhdWx0TnVtYmVyaW5nU2lzdGVtLFxuICAgICAgICAgICAgbG9jYWxlOiBOZ3hNYXRUaW1lcGlja2VyQWRhcHRlci5kZWZhdWx0TG9jYWxlXG4gICAgICAgIH0pLnRvRm9ybWF0KHRpbWVGb3JtYXQpO1xuICAgIH1cblxuICAgIHN0YXRpYyBpc0JldHdlZW4odGltZTogRGF0ZVRpbWUsIGJlZm9yZTogRGF0ZVRpbWUsIGFmdGVyOiBEYXRlVGltZSwgdW5pdDogXCJob3Vyc1wiIHwgXCJtaW51dGVzXCIgPSBcIm1pbnV0ZXNcIik6IGJvb2xlYW4ge1xuICAgICAgICBpZiAodW5pdCA9PT0gXCJob3Vyc1wiKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pc1NhbWVPckJlZm9yZSh0aW1lLCBhZnRlciwgdW5pdCkgJiYgdGhpcy5pc1NhbWVPckFmdGVyKHRpbWUsIGJlZm9yZSwgdW5pdCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHVuaXQgPT09IFwibWludXRlc1wiKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pc1NhbWVPckJlZm9yZSh0aW1lLCBhZnRlcikgJiYgdGhpcy5pc1NhbWVPckFmdGVyKHRpbWUsIGJlZm9yZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgaXNTYW1lT3JBZnRlcih0aW1lOiBEYXRlVGltZSwgY29tcGFyZVdpdGg6IERhdGVUaW1lLCB1bml0OiBcImhvdXJzXCIgfCBcIm1pbnV0ZXNcIiA9IFwibWludXRlc1wiKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICh1bml0ID09PSBcImhvdXJzXCIpIHtcbiAgICAgICAgICAgIHJldHVybiB0aW1lLmhvdXIgPj0gY29tcGFyZVdpdGguaG91cjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodW5pdCA9PT0gXCJtaW51dGVzXCIpIHtcbiAgICAgICAgICAgIHJldHVybiB0aW1lLmhhc1NhbWUoY29tcGFyZVdpdGgsIHVuaXQpIHx8IHRpbWUudmFsdWVPZigpID4gY29tcGFyZVdpdGgudmFsdWVPZigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3RhdGljIGlzU2FtZU9yQmVmb3JlKHRpbWU6IERhdGVUaW1lLCBjb21wYXJlV2l0aDogRGF0ZVRpbWUsIHVuaXQ6IFwiaG91cnNcIiB8IFwibWludXRlc1wiID0gXCJtaW51dGVzXCIpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHVuaXQgPT09IFwiaG91cnNcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRpbWUuaG91ciA8PSBjb21wYXJlV2l0aC5ob3VyO1xuICAgICAgICB9XG4gICAgICAgIGlmICh1bml0ID09PSBcIm1pbnV0ZXNcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRpbWUuaGFzU2FtZShjb21wYXJlV2l0aCwgdW5pdCkgfHwgdGltZS52YWx1ZU9mKCkgPD0gY29tcGFyZVdpdGgudmFsdWVPZigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3RhdGljIGlzVGltZUF2YWlsYWJsZSh0aW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBtaW4/OiBEYXRlVGltZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heD86IERhdGVUaW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhbnVsYXJpdHk/OiBcImhvdXJzXCIgfCBcIm1pbnV0ZXNcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbnV0ZXNHYXA/OiBudW1iZXIgfCBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0PzogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICghdGltZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29udmVydGVkVGltZSA9IHRoaXMucGFyc2VUaW1lKHRpbWUsIHtmb3JtYXR9KTtcbiAgICAgICAgY29uc3QgbWludXRlcyA9IGNvbnZlcnRlZFRpbWUubWludXRlO1xuXG4gICAgICAgIGlmIChtaW51dGVzR2FwICYmIG1pbnV0ZXMgPT09IG1pbnV0ZXMgJiYgbWludXRlcyAlIG1pbnV0ZXNHYXAgIT09IDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgWW91ciBtaW51dGVzIC0gJHttaW51dGVzfSBkb2VzblxcJ3QgbWF0Y2ggeW91ciBtaW51dGVzR2FwIC0gJHttaW51dGVzR2FwfWApO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGlzQWZ0ZXIgPSAobWluICYmICFtYXgpXG4gICAgICAgICAgICAmJiB0aGlzLmlzU2FtZU9yQWZ0ZXIoY29udmVydGVkVGltZSwgbWluLCBncmFudWxhcml0eSk7XG4gICAgICAgIGNvbnN0IGlzQmVmb3JlID0gKG1heCAmJiAhbWluKVxuICAgICAgICAgICAgJiYgdGhpcy5pc1NhbWVPckJlZm9yZShjb252ZXJ0ZWRUaW1lLCBtYXgsIGdyYW51bGFyaXR5KTtcbiAgICAgICAgY29uc3QgYmV0d2VlbiA9IChtaW4gJiYgbWF4KVxuICAgICAgICAgICAgJiYgdGhpcy5pc0JldHdlZW4oY29udmVydGVkVGltZSwgbWluLCBtYXgsIGdyYW51bGFyaXR5KTtcbiAgICAgICAgY29uc3QgaXNBdmFpbGFibGUgPSAhbWluICYmICFtYXg7XG5cbiAgICAgICAgcmV0dXJuIGlzQWZ0ZXIgfHwgaXNCZWZvcmUgfHwgYmV0d2VlbiB8fCBpc0F2YWlsYWJsZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgcGFyc2VUaW1lKHRpbWU6IHN0cmluZywgb3B0czogTmd4TWF0VGltZXBpY2tlck9wdGlvbnMpOiBEYXRlVGltZSB7XG4gICAgICAgIGNvbnN0IHtudW1iZXJpbmdTeXN0ZW0sIGxvY2FsZX0gPSBOZ3hNYXRUaW1lcGlja2VyQWRhcHRlci5fZ2V0TG9jYWxlT3B0aW9uc0J5VGltZSh0aW1lLCBvcHRzKTtcbiAgICAgICAgY29uc3QgaXNQZXJpb2RFeGlzdCA9IHRpbWUuc3BsaXQoXCIgXCIpLmxlbmd0aCA9PT0gMjtcbiAgICAgICAgY29uc3QgdGltZU1hc2sgPSBpc1BlcmlvZEV4aXN0ID8gTmd4TWF0VGltZXBpY2tlckZvcm1hdC5UV0VMVkVfU0hPUlQgOiBOZ3hNYXRUaW1lcGlja2VyRm9ybWF0LlRXRU5UWV9GT1VSX1NIT1JUO1xuXG4gICAgICAgIHJldHVybiBEYXRlVGltZS5mcm9tRm9ybWF0KHRpbWUsIHRpbWVNYXNrLCB7bnVtYmVyaW5nU3lzdGVtLCBsb2NhbGV9KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgdG9Mb2NhbGVUaW1lU3RyaW5nKHRpbWU6IHN0cmluZywgb3B0czogTmd4TWF0VGltZXBpY2tlck9wdGlvbnMgPSB7fSk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHtmb3JtYXQgPSBOZ3hNYXRUaW1lcGlja2VyQWRhcHRlci5kZWZhdWx0Rm9ybWF0LCBsb2NhbGUgPSBOZ3hNYXRUaW1lcGlja2VyQWRhcHRlci5kZWZhdWx0TG9jYWxlfSA9IG9wdHM7XG4gICAgICAgIGNvbnN0IGhvdXJDeWNsZSA9IGZvcm1hdCA9PT0gMjQgPyBcImgyM1wiIDogXCJoMTJcIjtcbiAgICAgICAgY29uc3QgdGltZUZvcm1hdCA9IHsuLi5EYXRlVGltZS5USU1FX1NJTVBMRSwgaG91ckN5Y2xlfTtcbiAgICAgICAgY29uc3QgdGltZU1hc2sgPSAoZm9ybWF0ID09PSAyNCkgPyBOZ3hNYXRUaW1lcGlja2VyRm9ybWF0LlRXRU5UWV9GT1VSX1NIT1JUIDogTmd4TWF0VGltZXBpY2tlckZvcm1hdC5UV0VMVkVfU0hPUlQ7XG5cbiAgICAgICAgcmV0dXJuIERhdGVUaW1lLmZyb21Gb3JtYXQodGltZSwgdGltZU1hc2spLnNldExvY2FsZShsb2NhbGUpLnRvTG9jYWxlU3RyaW5nKHRpbWVGb3JtYXQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIF9nZXRMb2NhbGVPcHRpb25zQnlUaW1lKHRpbWU6IHN0cmluZywgb3B0czogTmd4TWF0VGltZXBpY2tlck9wdGlvbnMpOiBMb2NhbGVPcHRpb25zIHtcbiAgICAgICAgY29uc3Qge251bWJlcmluZ1N5c3RlbSwgbG9jYWxlfSA9IERhdGVUaW1lLmxvY2FsKCkuc2V0TG9jYWxlKG9wdHMubG9jYWxlKS5yZXNvbHZlZExvY2FsZU9wdHMoKTtcbiAgICAgICAgY29uc3QgbG9jYWxlQ29uZmlnOiBMb2NhbGVPcHRpb25zID0ge1xuICAgICAgICAgICAgbnVtYmVyaW5nU3lzdGVtOiBudW1iZXJpbmdTeXN0ZW0gYXMgTnVtYmVyaW5nU3lzdGVtLFxuICAgICAgICAgICAgbG9jYWxlXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IGRlZmF1bHRDb25maWc6IExvY2FsZU9wdGlvbnMgPSB7XG4gICAgICAgICAgICBudW1iZXJpbmdTeXN0ZW06IE5neE1hdFRpbWVwaWNrZXJBZGFwdGVyLmRlZmF1bHROdW1iZXJpbmdTaXN0ZW0sXG4gICAgICAgICAgICBsb2NhbGU6IE5neE1hdFRpbWVwaWNrZXJBZGFwdGVyLmRlZmF1bHRMb2NhbGVcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gaXNOYU4ocGFyc2VJbnQodGltZSwgMTApKSA/IGxvY2FsZUNvbmZpZyA6IGRlZmF1bHRDb25maWc7XG4gICAgfVxufVxuIl19